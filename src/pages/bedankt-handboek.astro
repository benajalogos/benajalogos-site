---
export const prerender = false;

import BaseLayout from "@layouts/BaseLayout.astro";

const sessionId = Astro.url.searchParams.get("session_id")?.trim() ?? "";

const downloadUrl = sessionId
  ? `/api/download?session_id=${encodeURIComponent(sessionId)}&file=het-handboek`
  : "";
---

<BaseLayout title="Bedankt — Benaja Logos" noindex={true}>
  <div style="max-width:720px; margin:0 auto; padding-top:48px;">
    <h1>Bedankt voor je aankoop</h1>

    <p style="color:var(--muted);">
      Je download staat hieronder voor je klaar.
    </p>

    <div class="card" style="margin-top:50px; padding:20px;">
      <p style="margin-top:0px;">
        <strong>Het handboek voor leven — volledige inhoud van het boek</strong>
      </p>

      <button
        type="button"
        data-download="het-handboek"
        data-url={downloadUrl}
        style="
          display:inline-flex;
          align-items:center;
          justify-content:center;
          padding:12px 18px;
          background:var(--accent);
          color:#ffffff;
          border-radius:10px;
          font-weight:600;
          width:fit-content;
          border:none;
          cursor:pointer;
        "
      >
        Download
      </button>

      {!sessionId && (
        <p style="margin-top:12px; color:var(--muted);">
          Geen sessie-id gevonden. Open deze pagina via de betaling.
        </p>
      )}
    </div>

    <p style="margin-top:50px; color:var(--muted);">
      Tip: sla het bestand op je apparaat op zodat je het altijd bij de hand hebt.
    </p>

    <p style="margin-top:50px; color:var(--muted);">
      <strong>Werkt de download niet? Laat het ons weten</strong>
      <a href="mailto:support@benajalogos.nl?subject=Bericht%20via%20website%20Benaja%20Logos"> support@benajalogos.nl</a>.
    </p>
  </div>

  <script>
(() => {
  const btn = document.getElementById("buy-handboek");
  if (!(btn instanceof HTMLButtonElement)) return;

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    btn.style.opacity = "0.8";
    btn.textContent = "Even wachten…";

    try {
      const res = await fetch("/api/create-checkout-session-handboek", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      const data = await res.json();

      if (data?.url) {
        window.location.href = data.url;
        return;
      }

      alert("Fout bij starten betaling");
    } catch (e) {
      alert("Fout bij starten betaling");
    } finally {
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.textContent = "Koop nu";
    }
  });
})();
</script>
</BaseLayout>